# OTTRIP

 (예시는 **FastAPI + PostgreSQL + React(Next.js) + Docker/K8s** 조합을 기준으로 적었습니다. 익숙한 스택이 있으면 바꿔도 무방합니다.)

------

## 1 단계 — 요구사항 → 기능 명세서로 정제

| 대시보드      | 핵심 사용자 과업                                          | 1차 출시 범위             |
| ------------- | --------------------------------------------------------- | ------------------------- |
| **여행 일정** | 월간·주간(24h 슬롯) 달력에서 드래그로 일정 생성·이동·복사 | 기본 CRUD, 일정 간단 메모 |
| **지출 내역** | 항목·카테고리·통화·환율 자동 변환                         | 수동 입력 + CSV 업로드    |
| **상세 내용** | 항공·숙박·To-do·메모 등 객체화                            | 파일 첨부 보기            |
| **항공 상세** | e-티켓 파싱, 출/도착·예약 참조번호 저장                   | 읽기 전용                 |
| **숙박 상세** | 예약 확인서 파싱, 체크인/아웃·객실 유형                   | 읽기 전용                 |
| **AI 보조**   | 준비물 체크리스트·현지 팁·예산 경고                       | GPT 호출로 초안 생성      |

> **팁** : 처음부터 “완전 자동”을 목표로 하지 말고, ① 수동 입력 → ② 업로드·OCR → ③ AI 추론 순으로 고도화하면 리스크를 줄일 수 있습니다.

------

## 2 단계 — 아키텍처 청사진

```
┌─────────────────────────────┐
│  React / Next.js SPA (CSR)  │
│  - Calendar, Tables, DragNDrop│
│  - Auth (JWT + Refresh)      │
└─────────────▲────────────────┘
              │ REST / WebSocket
┌─────────────┴───────────────┐
│        FastAPI Gateway       │
│  /api/v1/…                   │
│  - Auth, Rate-limit, CORS    │
├─────────────┬───────────────┤
│ Trip Service │ Expense Svc   │  ▶ PostgreSQL (Timescale ext. 추천)
├─────────────┼───────────────┤
│ File-Ingest  │ AI Service    │  ▶ MinIO (객체 스토리지)
└─────────────┴───────────────┘
      ▲ gRPC / Kafka / Celery (비동기)
      │
┌─────┴─────┐
│OCR & NLP  │  ▶ Tesseract, pdfplumber, spaCy
│LLM Runner │  ▶ OpenAI GPT-4o or local Llama-3
└───────────┘
```

- **모노리포**(backend, frontend, infra) + **Docker Compose**로 로컬 개발 → K8s로 배포
- 업로드 파일은 S3 호환 스토리지(MinIO) → 인제스트 워커에서 ① OCR ② Regex/NLP 추출 ③ DB 저장
- LLM 호출은 비동기 태스크(예: Celery)로 돌려서 응답 지연 방지

------

## 3 단계 — 데이터 모델 초안 (PostgreSQL)

```mermaid
erDiagram
    trip ||--o{ day : has
    day  ||--o{ plan_item : includes
    trip ||--o{ expense : spends
    trip ||--o{ attachment : owns
    attachment ||--|{ ai_extract : enriches

    trip {
      uuid id PK
      varchar title
      timestamptz start_date
      timestamptz end_date
      uuid owner_id
    }
    day {
      uuid id PK
      uuid trip_id FK
      timestamptz date
    }
    plan_item {
      uuid id PK
      uuid day_id FK
      timestamptz start_time
      timestamptz end_time
      varchar type  -- flight / hotel / activity / note
      jsonb   meta  -- flexible
    }
    expense {
      uuid id PK
      uuid trip_id FK
      money amount
      varchar currency
      varchar category
      text memo
    }
    attachment {
      uuid id PK
      uuid trip_id FK
      varchar file_path
      varchar file_type
      timestamptz uploaded_at
    }
    ai_extract {
      uuid id PK
      uuid attachment_id FK
      jsonb data      -- structured fields
      varchar status  -- pending / done / error
    }
```

------

## 4 단계 — 백엔드 API 스켈레톤 (FastAPI)

```python
# router_trip.py
@router.post("/trips", response_model=TripOut)
async def create_trip(trip: TripCreate, user=Depends(current_user)): ...

@router.post("/trips/{trip_id}/attachments")
async def upload_file(file: UploadFile, bg_tasks: BackgroundTasks): ...
```

- **async SQLAlchemy** + alembic 마이그레이션
- Pydantic v3 모델 (BaseModel.model_dump(mode="json"))
- FastAPI Workers × Gunicorn + Uvicorn

------

## 5 단계 — 프론트 컴포넌트 로드맵 (Next.js 14+App Router)

1. **/dashboard**
   - `<CalendarBoard />` — FullCalendar + drag&drop
   - `<ExpenseTable />` — editable rows + currency converter
2. **/trip/[id]**
   - `<DetailTabs />` — Flight / Hotel / Checklist / Notes
3. **Global**
   - `<Dropzone />` — react-dropzone → POST `/attachments`
   - Zustand or Redux Toolkit Query로 서버 캐싱

------

## 6 단계 — AI · 파싱 파이프라인

| 단계               | 기술/라이브러리                 | 산출물           |
| ------------------ | ------------------------------- | ---------------- |
| 1. 파일 업로드     | presigned URL → MinIO           | RAW PDF/IMG      |
| 2. OCR/텍스트 추출 | Tesseract (eng+kor), pdfplumber | plain text       |
| 3. 구조화          | spaCy NER + custom Regex        | JSON (dict)      |
| 4. LLM 정제        | GPT-4o / Llama-3 Instr.         | 완전 JSON schema |
| 5. DB 삽입         | SQLAlchemy                      | ai_extract.row   |

- **LangChain Expression Language**로 ②+③+④ 파이프 정의

- 프롬프트 예시:

  ```
  You are an expert travel agent. Normalize the following e-ticket text
  into JSON: {"flight_number": …, "departure": …}
  ```

------

## 7 단계 — 개발 타임라인 (8주 예시)

| 주차 | 목표                                              |
| ---- | ------------------------------------------------- |
| 1    | Repo 세팅, CI/CD, DB 스키마, Auth 구현            |
| 2    | Trip/Day/Plan CRUD API & 달력 UI                  |
| 3    | Expense API & 테이블 UI                           |
| 4    | 파일 업로드 → MinIO, Dropzone 완료                |
| 5    | OCR + 파싱 워커 MVP, Flight/Hotel 상세 탭         |
| 6    | LLM 접목(준비물·팁 생성) + WebSocket 실시간 알림  |
| 7    | 종단(E2E) 테스트, Lighthouse·Core Web Vitals 튜닝 |
| 8    | 클라우드 배포(K8s), Grafana 대시보드, 문서화      |

------

## 8 단계 — 다음 우선순위 체크리스트

-  **멀티 국가/통화 지원** (환율 API, locale)
-  오프라인 캐시(PWA) — 비행 중에도 조회 가능
-  공유 링크(읽기 전용) & 협업(Write)
-  iCal/Google Calendar Sync
-  비용 예산 초과 시 알림(Budget Guardrails)

------

### 시작할 때 꼭 기억할 것

1. **MVP 스코프 고정** : 달력 + 지출 + 파일 업로드까지만 “완전 동작”하도록 먼저 만드세요.
2. **AI 는 보조, UX 가 핵심** : 추천 품질보다 **입력 피로를 줄이는 UI**가 성공 요인입니다.
3. **비동기/백그라운드 처리**로 사용자 대기 시간을 2초 이내로 유지하세요.

필요한 부분(예: OCR 튜닝, LLM 프롬프트 설계, K8s 헬름 차트)이 생기면 언제든 세부적으로 파고들어 드릴게요. 화이팅입니다!









## 기본 구조

```
.  # Monorepo for ottrip 여행 플래너 애플리케이션
├── server/                   # FastAPI 백엔드
│   ├── app/                  # 애플리케이션 코드
│   │   ├── calendar/         # 여행 일정 도메인
│   │   │   ├── router.py     # calendar 관련 REST 엔드포인트
│   │   │   ├── service.py    # 비즈니스 로직
│   │   │   ├── repository.py # DB CRUD 접속 계층
│   │   │   └── models.py     # Pydantic/SQLModel 스키마
│   │   ├── expense/          # 지출 관리 도메인
│   │   │   ├── router.py
│   │   │   ├── service.py
│   │   │   ├── repository.py
│   │   │   └── models.py
│   │   ├── detail/           # 상세 내용 도메인 (메모, 투두 등)
│   │   │   ├── router.py
│   │   │   ├── service.py
│   │   │   ├── repository.py
│   │   │   └── models.py
│   │   ├── flight/           # 항공권 분석 도메인
│   │   │   ├── router.py
│   │   │   ├── service.py
│   │   │   ├── repository.py
│   │   │   └── models.py
│   │   ├── hotel/            # 숙박 분석 도메인
│   │   │   ├── router.py
│   │   │   ├── service.py
│   │   │   ├── repository.py
│   │   │   └── models.py
│   │   └── ai/               # AI 분석 및 추천 도메인
│   │       ├── router.py
│   │       ├── service.py
│   │       ├── repository.py
│   │       └── models.py     # AI 관련 스키마 (추천 결과 등)
│   ├── alembic/              # 데이터베이스 마이그레이션 설정
│   ├── alembic.ini
│   ├── migrations/           # 버전별 마이그레이션 스크립트
│   ├── Dockerfile            # 서버용 Docker 이미지 정의
│   └── pyproject.toml        # Poetry 설정 (FastAPI, SQLModel 등)
├── client/                   # Next.js 프론트엔드
│   ├── app/                  # Next.js App Router
│   │   ├── trip/             # 여행 단위 페이지
│   │   │   └── [tripId]/     # 개별 여행
│   │   │       ├── calendar/page.tsx  # 달력 UI
│   │   │       ├── expense/page.tsx   # 지출내역 UI
│   │   │       ├── details/page.tsx   # 세부 메모·투두 UI
│   │   │       ├── flight/page.tsx    # 항공 상세 UI
│   │   │       └── hotel/page.tsx     # 숙박 상세 UI
│   ├── public/               # 정적 자산 (이미지, favicon)
│   ├── package.json          # pnpm workspace 및 스크립트
│   ├── next.config.js        # Next.js 설정
│   └── tailwind.config.js    # Tailwind CSS 설정
├── packages/                 # 공통 패키지
│   └── shared/               # DTO · 타입 · 유틸리티
│       ├── types/            # API ↔ 프론트인터페이스 정의
│       │   ├── trip.ts
│       │   ├── planItem.ts
│       │   ├── expense.ts
│       │   ├── detail.ts
│       │   ├── flight.ts
│       │   ├── hotel.ts
│       │   └── ai.ts
│   └── package.json          # npm 패키지 설정
├── docker-compose.yml        # 공통 서비스 정의
├── docker-compose.dev.yml    # 개발 환경용 오버라이드
├── README.md                 # 프로젝트 개요 및 시작 가이드
└── pyproject.toml            # Monorepo 워크스페이스 설정
```

